---

- name: Download subject public key & add
  apt_key:
    url: https://bintray.com/user/downloadSubjectPublicKey?username=bintray
    state: present

- name: Add kontena.list
  copy:
    content: "deb http://dl.bintray.com/kontena/ubuntu {{ ansible_distribution_release }} main"
    dest: /etc/apt/sources.list.d/kontena.list

- name: Ensure resolvconf is installed.
  when: ka_resolvconf_install
  package: name=resolvconf state=installed

- name: Install Kontena Agent without interactive mode & postinstall script
  shell: >
    apt-get update \
    && apt-get download kontena-agent \
    && dpkg --unpack kontena-agent*.deb \
    && rm -f /var/lib/dpkg/info/kontena-agent.postinst \
    && dpkg --configure kontena-agent \
    && apt-get install -yf
  args:
    chdir: /tmp # W: Can't drop privileges for downloading as file ...

- name: Configure Kontena Agent (xenial)
  when: ansible_distribution_release == 'xenial'
  template:
    src: "templates/kontena-agent.env.j2"
    dest: "/etc/kontena-agent.env"

- name: Configure Kontena Agent (trusty)
  when: ansible_distribution_release == 'trusty'
  template:
    src: "templates/kontena-agent.env.j2"
    dest: "/etc/default/kontena-agent"

- name: Restart services
  when: ansible_distribution_release == "xenial"
  systemd:
    name: "{{ item }}"
    daemon_reload: yes
    state: restarted
  with_items:
    - docker
    - kontena-agent

- name: Restart services
  when: ansible_distribution_release == "trusty"
  service:
    name: "{{ item }}"
    state: restarted
  with_items:
    - docker
    - kontena-agent
